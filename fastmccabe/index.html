<!DOCTYPE html>
<html>
    <head>
        <title>Gaussian Pyramid McCabeism</title>
        <link rel="stylesheet" type="text/css" href="style.css"/>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
        <script type="text/javascript" src="../3rd/dat.gui.js"></script>
        <script type="text/javascript" src="../3rd/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="render.js"></script>
        <script type="x-shader/x-vertex" id="standardVertexShader">
            varying vec2 vUv;

            void main()
            {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>
        <script type="x-shader/x-fragment" id="screenFragmentShader">
            varying vec2 vUv;
            uniform sampler2D iSource;

            void main()
            {
                vec3 is = texture2D(iSource, vUv).xyz;
                gl_FragColor = vec4(is, 1.0);
            }
        </script>
        <script type="x-shader/x-fragment" id="noiseFragmentShader">
            varying vec2 vUv;

            float rand(vec2 co){
                return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
            }

            void main()
            {
                float is = rand(vUv);
                gl_FragColor = vec4(is);
            }
        </script>
        <script type="x-shader/x-vertex" id="gaussianPyramidVertexShader0">
            varying vec2 blurTexCoords0[8];
            varying vec2 blurTexCoords1[8];
            varying vec2 blurTexCoords2[4];
            varying vec2 blurTexCoords3[4];

            varying vec2 vUv;

            uniform float screenWidth;
            uniform float screenHeight;

            void main()
            {
                float ix = 1.0 / screenWidth;
                float iy = 1.0 / screenHeight;

                blurTexCoords0[ 0] = uv + vec2(-ix * 4.0, 0.0);
                blurTexCoords0[ 1] = uv + vec2(-ix * 3.0, 0.0);
                blurTexCoords0[ 2] = uv + vec2(-ix * 2.0, 0.0);
                blurTexCoords0[ 3] = uv + vec2(-ix * 1.0, 0.0);
                blurTexCoords0[ 4] = uv + vec2( ix * 1.0, 0.0);
                blurTexCoords0[ 5] = uv + vec2( ix * 2.0, 0.0);
                blurTexCoords0[ 6] = uv + vec2( ix * 3.0, 0.0);
                blurTexCoords0[ 7] = uv + vec2( ix * 4.0, 0.0);

                blurTexCoords1[ 0] = uv + vec2(0.0, -iy * 4.0);
                blurTexCoords1[ 1] = uv + vec2(0.0, -iy * 3.0);
                blurTexCoords1[ 2] = uv + vec2(0.0, -iy * 2.0);
                blurTexCoords1[ 3] = uv + vec2(0.0, -iy * 1.0);
                blurTexCoords1[ 4] = uv + vec2(0.0,  iy * 1.0);
                blurTexCoords1[ 5] = uv + vec2(0.0,  iy * 2.0);
                blurTexCoords1[ 6] = uv + vec2(0.0,  iy * 3.0);
                blurTexCoords1[ 7] = uv + vec2(0.0,  iy * 4.0);

                blurTexCoords2[ 0] = uv + vec2(-ix * 8.0, 0.0);
                blurTexCoords2[ 1] = uv + vec2(-ix * 6.0, 0.0);
                blurTexCoords2[ 2] = uv + vec2( ix * 6.0, 0.0);
                blurTexCoords2[ 3] = uv + vec2( ix * 8.0, 0.0);

                blurTexCoords3[ 0] = uv + vec2(0.0, -iy * 8.0);
                blurTexCoords3[ 1] = uv + vec2(0.0, -iy * 6.0);
                blurTexCoords3[ 2] = uv + vec2(0.0,  iy * 6.0);
                blurTexCoords3[ 3] = uv + vec2(0.0,  iy * 8.0);

                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>
        <script type="x-shader/x-vertex" id="gaussianPyramidVertexShader1">
            varying vec2 blurTexCoords0[8];
            varying vec2 blurTexCoords1[8];
            varying vec2 blurTexCoords2[4];
            varying vec2 blurTexCoords3[4];

            varying vec2 vUv;

            uniform float screenWidth;
            uniform float screenHeight;

            void main()
            {
                float ix = 1.0 / screenWidth;
                float iy = 1.0 / screenHeight;

                blurTexCoords0[ 0] = uv + vec2(-ix * 16.0, 0.0);
                blurTexCoords0[ 1] = uv + vec2(-ix * 12.0, 0.0);
                blurTexCoords0[ 2] = uv + vec2(-ix *  8.0, 0.0);
                blurTexCoords0[ 3] = uv + vec2(-ix *  4.0, 0.0);
                blurTexCoords0[ 4] = uv + vec2( ix *  4.0, 0.0);
                blurTexCoords0[ 5] = uv + vec2( ix *  8.0, 0.0);
                blurTexCoords0[ 6] = uv + vec2( ix * 12.0, 0.0);
                blurTexCoords0[ 7] = uv + vec2( ix * 16.0, 0.0);

                blurTexCoords1[ 0] = uv + vec2(0.0, -iy * 16.0);
                blurTexCoords1[ 1] = uv + vec2(0.0, -iy * 12.0);
                blurTexCoords1[ 2] = uv + vec2(0.0, -iy *  8.0);
                blurTexCoords1[ 3] = uv + vec2(0.0, -iy *  4.0);
                blurTexCoords1[ 4] = uv + vec2(0.0,  iy *  4.0);
                blurTexCoords1[ 5] = uv + vec2(0.0,  iy *  8.0);
                blurTexCoords1[ 6] = uv + vec2(0.0,  iy * 12.0);
                blurTexCoords1[ 7] = uv + vec2(0.0,  iy * 16.0);

                blurTexCoords2[ 0] = uv + vec2(-ix * 32.0, 0.0);
                blurTexCoords2[ 1] = uv + vec2(-ix * 24.0, 0.0);
                blurTexCoords2[ 2] = uv + vec2( ix * 24.0, 0.0);
                blurTexCoords2[ 3] = uv + vec2( ix * 32.0, 0.0);

                blurTexCoords3[ 0] = uv + vec2(0.0, -iy * 32.0);
                blurTexCoords3[ 1] = uv + vec2(0.0, -iy * 24.0);
                blurTexCoords3[ 2] = uv + vec2(0.0,  iy * 24.0);
                blurTexCoords3[ 3] = uv + vec2(0.0,  iy * 32.0);

                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>
        <script type="x-shader/x-vertex" id="gaussianPyramidVertexShader2">
            varying vec2 blurTexCoords0[8];
            varying vec2 blurTexCoords1[8];
            varying vec2 blurTexCoords2[4];
            varying vec2 blurTexCoords3[4];

            varying vec2 vUv;

            uniform float screenWidth;
            uniform float screenHeight;

            void main()
            {
                float ix = 1.0 / screenWidth;
                float iy = 1.0 / screenHeight;

                blurTexCoords0[ 0] = uv + vec2(-ix * 64.0, 0.0);
                blurTexCoords0[ 1] = uv + vec2(-ix * 48.0, 0.0);
                blurTexCoords0[ 2] = uv + vec2(-ix * 32.0, 0.0);
                blurTexCoords0[ 3] = uv + vec2(-ix * 16.0, 0.0);
                blurTexCoords0[ 4] = uv + vec2( ix * 16.0, 0.0);
                blurTexCoords0[ 5] = uv + vec2( ix * 32.0, 0.0);
                blurTexCoords0[ 6] = uv + vec2( ix * 48.0, 0.0);
                blurTexCoords0[ 7] = uv + vec2( ix * 64.0, 0.0);

                blurTexCoords1[ 0] = uv + vec2(0.0, -iy * 64.0);
                blurTexCoords1[ 1] = uv + vec2(0.0, -iy * 48.0);
                blurTexCoords1[ 2] = uv + vec2(0.0, -iy * 32.0);
                blurTexCoords1[ 3] = uv + vec2(0.0, -iy * 16.0);
                blurTexCoords1[ 4] = uv + vec2(0.0,  iy * 16.0);
                blurTexCoords1[ 5] = uv + vec2(0.0,  iy * 32.0);
                blurTexCoords1[ 6] = uv + vec2(0.0,  iy * 48.0);
                blurTexCoords1[ 7] = uv + vec2(0.0,  iy * 64.0);

                blurTexCoords2[ 0] = uv + vec2(-ix * 128.0, 0.0);
                blurTexCoords2[ 1] = uv + vec2(-ix *  96.0, 0.0);
                blurTexCoords2[ 2] = uv + vec2( ix *  96.0, 0.0);
                blurTexCoords2[ 3] = uv + vec2( ix * 128.0, 0.0);

                blurTexCoords3[ 0] = uv + vec2(0.0, -iy * 128.0);
                blurTexCoords3[ 1] = uv + vec2(0.0, -iy *  96.0);
                blurTexCoords3[ 2] = uv + vec2(0.0,  iy *  96.0);
                blurTexCoords3[ 3] = uv + vec2(0.0,  iy * 128.0);

                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>
        <script type="x-shader/x-vertex" id="gaussianPyramidVertexShader3">
            varying vec2 blurTexCoords0[8];
            varying vec2 blurTexCoords1[8];
            varying vec2 blurTexCoords2[4];
            varying vec2 blurTexCoords3[4];

            varying vec2 vUv;

            uniform float screenWidth;
            uniform float screenHeight;

            void main()
            {
                float ix = 1.0 / screenWidth;
                float iy = 1.0 / screenHeight;

                blurTexCoords0[ 0] = uv + vec2(-ix * 256.0, 0.0);
                blurTexCoords0[ 1] = uv + vec2(-ix * 192.0, 0.0);
                blurTexCoords0[ 2] = uv + vec2(-ix * 128.0, 0.0);
                blurTexCoords0[ 3] = uv + vec2(-ix *  64.0, 0.0);
                blurTexCoords0[ 4] = uv + vec2( ix *  64.0, 0.0);
                blurTexCoords0[ 5] = uv + vec2( ix * 128.0, 0.0);
                blurTexCoords0[ 6] = uv + vec2( ix * 192.0, 0.0);
                blurTexCoords0[ 7] = uv + vec2( ix * 256.0, 0.0);

                blurTexCoords1[ 0] = uv + vec2(0.0, -iy * 256.0);
                blurTexCoords1[ 1] = uv + vec2(0.0, -iy * 192.0);
                blurTexCoords1[ 2] = uv + vec2(0.0, -iy * 128.0);
                blurTexCoords1[ 3] = uv + vec2(0.0, -iy *  64.0);
                blurTexCoords1[ 4] = uv + vec2(0.0,  iy *  64.0);
                blurTexCoords1[ 5] = uv + vec2(0.0,  iy * 128.0);
                blurTexCoords1[ 6] = uv + vec2(0.0,  iy * 192.0);
                blurTexCoords1[ 7] = uv + vec2(0.0,  iy * 256.0);

                blurTexCoords2[ 0] = uv + vec2(-ix * 512.0, 0.0);
                blurTexCoords2[ 1] = uv + vec2(-ix * 384.0, 0.0);
                blurTexCoords2[ 2] = uv + vec2( ix * 384.0, 0.0);
                blurTexCoords2[ 3] = uv + vec2( ix * 512.0, 0.0);

                blurTexCoords3[ 0] = uv + vec2(0.0, -iy * 512.0);
                blurTexCoords3[ 1] = uv + vec2(0.0, -iy * 384.0);
                blurTexCoords3[ 2] = uv + vec2(0.0,  iy * 384.0);
                blurTexCoords3[ 3] = uv + vec2(0.0,  iy * 512.0);

                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>
        <script type="x-shader/x-vertex" id="gaussianPyramidFragmentShader">
            uniform sampler2D iSource;
            uniform sampler2D sSource;

            varying vec2 blurTexCoords0[8];
            varying vec2 blurTexCoords1[8];
            varying vec2 blurTexCoords2[4];
            varying vec2 blurTexCoords3[4];

            varying vec2 vUv;

            uniform float screenWidth;
            uniform float screenHeight;

            #define I0(i) texture2D(iSource, blurTexCoords0[i]).w
            #define S0y(i) texture2D(sSource, blurTexCoords0[i]).y
            #define S2y(i) texture2D(sSource, blurTexCoords2[i]).y
            #define S1x(i) texture2D(sSource, blurTexCoords1[i]).x
            #define S1z(i) texture2D(sSource, blurTexCoords1[i]).z
            #define S3z(i) texture2D(sSource, blurTexCoords3[i]).z

            void main()
            {
                vec4 f = vec4(0.0);

                /* sigma = 2
                    0.005172754662519048;
                    0.02976714782325323;
                    0.10389755476861752;
                    0.21995112517117948;
                    0.28242283514886135;
                    0.21995112517117948;
                    0.10389755476861752;
                    0.02976714782325323;
                    0.005172754662519048;
                */

                float IC = texture2D(iSource, vUv).w;
                vec3  SC = texture2D(sSource, vUv).xyz;

                // normalized gaussian with sigma = 3
                f += vec4(I0(0), S1x(0), S2y(0), S3z(0)) * 0.0328447465496729;
                f += vec4(I0(1), S1x(1), S2y(1), S3z(1)) * 0.071490858439652;
                f += vec4(I0(2), S1x(2), S0y(0), S1z(0)) * 0.12460206049450015;
                f += vec4(I0(3), S1x(3), S0y(2), S1z(2)) * 0.17389618381745298;
                f += vec4(IC   , SC                    ) * 0.19433230139744398;
                f += vec4(I0(4), S1x(4), S0y(5), S1z(5)) * 0.17389618381745298;
                f += vec4(I0(5), S1x(5), S0y(7), S1z(7)) * 0.12460206049450015;
                f += vec4(I0(6), S1x(6), S2y(2), S3z(2)) * 0.071490858439652;
                f += vec4(I0(7), S1x(7), S2y(3), S3z(3)) * 0.0328447465496729;

                gl_FragColor = vec4(f);
            }
        </script>
        <script type="x-shader/x-fragment" id="mccabeFragmentShader">
            varying vec2 vUv;
            uniform sampler2D bSource0;
            uniform sampler2D bSource1;
            uniform sampler2D bSource2;
            uniform sampler2D bSource3;
            uniform sampler2D iSource;

            uniform float hard;
            uniform float sharp;
            uniform float exponent;
            uniform float scale;
            uniform float rate;

            vec4 sigmoid(vec4 x, float k) {
                return (2.0 / (1.0 + exp(-k * x))) - 1.0;
            }

            void main()
            {
                // weights
                //vec4 a0 = vec4(0.001, 0.002, 0.004, 0.008);
                //vec4 a1 = vec4(0.012, 0.016, 0.024, 0.032);

                vec4 i0 = vec4(1.0, 2.0, 3.0, 4.0);
                vec4 i1 = vec4(5.0, 6.0, 7.0, 8.0);

                vec4 ev = vec4(exponent);
                vec4 a0 = scale * pow(i0, ev);
                vec4 a1 = scale * pow(i1, ev);

                vec4 one = vec4(1.0);

                vec4 b0 = vec4(texture2D(bSource0, vUv).yw, texture2D(bSource1, vUv).yw);
                vec4 b1 = vec4(texture2D(bSource2, vUv).yw, texture2D(bSource3, vUv).yw);
                vec4 is = texture2D(iSource, vUv);

                // difference of gaussians
                vec4 dog0 = vec4(is.x - b0.x, b0.x - b0.y, b0.y - b0.z, b0.z - b1.w);
                vec4 dog1 = vec4(b1.w - b1.x, b1.x - b1.y, b1.y - b1.z, b1.z - b1.w);

                // combined softmin and mccabe update rule
                vec4 q0 = exp(- 10.0 * hard * abs(dog0));
                vec4 q1 = exp(- 10.0 * hard * abs(dog1));
                float n = dot(sigmoid(dog0, sharp) * a0 * q0, one) + dot(sigmoid(dog1, sharp) * a1 * q1, one);
                float d = dot(q0, one) + dot(q1, one);

                float final = clamp(is.x + rate * n/d, 0.0, 1.0);

                gl_FragColor = vec4(final);

            }
        </script>
        <script type="x-shader/x-fragment" id="debugFragmentShader">
            varying vec2 vUv;
            uniform sampler2D bSource0;
            uniform sampler2D bSource1;
            uniform sampler2D bSource2;
            uniform sampler2D bSource3;
            uniform sampler2D iSource;

            uniform float hard;

            void main()
            {
                vec4 one = vec4(1.0);

                vec4 b0 = vec4(texture2D(bSource0, vUv).yw, texture2D(bSource1, vUv).yw);
                vec4 b1 = vec4(texture2D(bSource2, vUv).yw, texture2D(bSource3, vUv).yw);
                vec4 is = texture2D(iSource, vUv);

                float hh = hard * hard;
                vec4 d0 = vec4(hh, 1.0 - 2.0 * hard + hh, 4.0 - 4.0 * hard + hh, 9.0 - 6.0 * hard + hh);
                vec4 d1 = vec4(16.0 - 8.0 * hard + hh, 25.0 - 10.0 * hard + hh, 36.0 - 12.0 * hard + hh, 49.0 - 14.0 * hard + hh);

                float n = dot(b0 / (one + d0), one)  + dot(b1 / (one + d1), one);
                float d = dot(one / (one + d0), one) + dot(one / (one + d1), one);

                gl_FragColor = vec4(n / d);
            }
        </script>
        <meta charset="UTF-8">
    </head>
    <body>
        <div id="simulation">
            <canvas id="myCanvas" class="viewer" style="width:1024px;height:1024px"></canvas>
        </div>
    </body>
</html>

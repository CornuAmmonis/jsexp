<!DOCTYPE html>
<html lang="en">

<head>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://getbootstrap.com/examples/justified-nav/justified-nav.css" rel="stylesheet">
    <style>
        .axis path {
            fill: none;
            stroke: #777;
            shape-rendering: crispEdges;
        }
        .axis text {
            font-family: Lato;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="jumbotron">
            <svg id="visualisation" width="1000" height="500"></svg>
            <script>
                var generateData = function(samples) {
                    var arr = [];
                    for (var i = 0; i < samples; i++) {
                        arr.push(Math.random());
                    }
                    return arr;
                };

                var convolution = function(arr, minmax) {
                    var out = [];
                    var len = arr.length;
                    var radius = 4;
                    var sigma = 2.5;
                    var soft = minmax;
                    var scale = 5.0;
                    var abssoft = Math.abs(soft);

                    for (var i = 0; i < len; i++) {
                        var numer = 0.0;
                        var denom = 0.0;
                        for (var j = -radius; j <= radius; j++) {
                            var val = arr[positiveMod(i + j, len)];
                            var f = gaussian(j, 0, sigma, soft);
                            var v = soft * scale;
                            var p = f * val;
                            var q = Math.exp(v * val);
                            var n = p * q;
                            var d = (1 - abssoft) / len + abssoft * q;
                            numer += n;
                            denom += d;
                        }
                        out.push([i, numer / denom]);
                    }

                    return out;
                };

                var gaussian = function(x, mu, sigma, norm) {
                    var n = (x - mu) * (x - mu);
                    var m = 2 * sigma * sigma;
                    var d = Math.sqrt(Math.PI * m);
                    var dn = d + Math.abs(norm) * (1 - d);
                    return Math.exp(-n / m) / dn;
                };

                var positiveMod = function(x, m) {
                    var mod = x % m;
                    return x >= 0 ? mod : m + mod;
                };

                var generateConvolutions = function(num, init) {
                    var interval = 2.0 / num;
                    var out = [];
                    for (var i = 0; i < num; i++) {
                        out.push([]);
                        var conv = convolution(init, -1 + interval * i);
                        out[i].push(conv);
                    }
                    return out;
                };

                var initChart = function() {
                    var samples = 100;
                    var initData = generateData(samples);
                    var convs = 10;
                    var convolutions = generateConvolutions(convs, initData);
                    var vis = d3.select("#visualisation"),
                            WIDTH = 1000,
                            HEIGHT = 500,
                            MARGINS = {
                                top: 20,
                                right: 20,
                                bottom: 20,
                                left: 50
                            },
                            xScale = d3.scale.linear().range([MARGINS.left, WIDTH - MARGINS.right]).domain([0, 100]),
                            //yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0, 1.0]),
                            //xScale = d3.scale.ordinal().range([MARGINS.left, WIDTH - MARGINS.right]).domain([0, 100]),
                            yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0, 1.0]),
                            xAxis = d3.svg.axis()
                                    .scale(xScale),
                            yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left");

                    vis.append("svg:g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
                            .call(xAxis);
                    vis.append("svg:g")
                            .attr("class", "y axis")
                            .attr("transform", "translate(" + (MARGINS.left) + ",0)")
                            .call(yAxis);
                    var lineGen = d3.svg.line()
                            .x(function(d) {
                                return xScale(d[0]);
                            })
                            .y(function(d) {
                                return yScale(d[1]);
                            });
                            //.interpolate("basis");
                    for (var i = 0; i < convs; i++) {
                        vis.append('svg:path')
                                .attr('d', lineGen(convolutions[i][0]))
                                .attr('stroke', 'green')
                                .attr('stroke-width', 2)
                                .attr('fill', 'none');
                    }
                };

                window.onload = initChart;
            </script>
        </div>
    </div>
</body>
</html>